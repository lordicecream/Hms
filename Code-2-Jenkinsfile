pipeline {
    agent any

    environment {
        GIT_CREDENTIALS_ID = 'your-git-credentials-id'
        TRINO_CREDENTIALS_ID = 'your-trino-credentials-id'
        DOCKER_IMAGE = 'python:3.9-slim'  // or whichever lightweight python image you want
    }

    parameters {
        string(name: 'SOURCE_TRINO_HOST', description: 'Source Trino Host')
        string(name: 'DEST_TRINO_HOST', description: 'Destination Trino Host')
        string(name: 'SOURCE_CATALOG', description: 'Source Catalog')
        string(name: 'DEST_CATALOG', description: 'Destination Catalog')
        string(name: 'SCHEMA_NAME', description: 'Schema to replicate')
        choice(name: 'FULL_SCHEMA_REPLICATE', choices: ['yes', 'no'], description: 'Replicate full schema or selective tables?')
        choice(name: 'DRY_RUN', choices: ['true', 'false'], description: 'Dry Run or Actual Execution?')
    }

    stages {
        stage('Checkout') {
            steps {
                git credentialsId: "${GIT_CREDENTIALS_ID}", url: 'https://your-git-repo-url/trino-replicate.git', branch: 'master'
            }
        }

        stage('Fetch Trino Credentials') {
            steps {
                withCredentials([usernamePassword(credentialsId: "${TRINO_CREDENTIALS_ID}", usernameVariable: 'TRINO_USER', passwordVariable: 'TRINO_PASSWORD')]) {
                    sh '''
                        echo "Fetched Trino credentials"
                    '''
                }
            }
        }

        stage('Run Replication Script') {
            steps {
                sh """
                    docker pull ${DOCKER_IMAGE}
                    docker run --rm -v "$PWD":/app -w /app ${DOCKER_IMAGE} \
                    python3 replicate_trino.py \
                        --source_trino_host "${SOURCE_TRINO_HOST}" \
                        --dest_trino_host "${DEST_TRINO_HOST}" \
                        --source_catalog "${SOURCE_CATALOG}" \
                        --dest_catalog "${DEST_CATALOG}" \
                        --schema_name "${SCHEMA_NAME}" \
                        --full_schema_replicate "${FULL_SCHEMA_REPLICATE}" \
                        --username "${TRINO_USER}" \
                        --password "${TRINO_PASSWORD}" \
                        --dry_run "${DRY_RUN}"
                """
            }
        }
    }
}
