pipeline {
    agent {
        docker {
            image 'python:3.10-slim'
            args '-u root:root' // Run as root so we can install packages
        }
    }
    environment {
        SOURCE_TRINO = '' // Will be populated from input
        DEST_TRINO = ''   // Will be populated from input
    }
    parameters {
        string(name: 'SOURCE_TRINO', description: 'Source Trino Host URL (eg. https://trino-source.host)')
        string(name: 'DEST_TRINO', description: 'Destination Trino Host URL (eg. https://trino-dest.host)')
        string(name: 'SOURCE_CATALOG', defaultValue: 'hmsa', description: 'Source Catalog Name')
        string(name: 'DEST_CATALOG', defaultValue: 'hmsb', description: 'Destination Catalog Name')
        string(name: 'SCHEMA_NAME', description: 'Schema to replicate (eg. abc)')
        choice(name: 'FULL_SCHEMA_REPLICATE', choices: ['yes', 'no'], description: 'Replicate full schema or only selected tables?')
        string(name: 'GIT_BRANCH', defaultValue: 'master', description: 'Git branch to use')
    }
    stages {
        stage('Checkout Code') {
            steps {
                git branch: params.GIT_BRANCH, credentialsId: 'git-credentials', url: 'https://your-git-server.com/your-repo/trino-replicate.git'
            }
        }
        stage('Install Python Packages') {
            steps {
                sh 'pip install trino'
            }
        }
        stage('Run Metadata Replication') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'trino-credentials', usernameVariable: 'TRINO_USER', passwordVariable: 'TRINO_PASS')]) {
                    sh """
                        python replicate_metadata.py \
                            --source_host ${params.SOURCE_TRINO} \
                            --dest_host ${params.DEST_TRINO} \
                            --source_catalog ${params.SOURCE_CATALOG} \
                            --dest_catalog ${params.DEST_CATALOG} \
                            --schema_name ${params.SCHEMA_NAME} \
                            --full_schema_replicate ${params.FULL_SCHEMA_REPLICATE} \
                            --username $TRINO_USER \
                            --password $TRINO_PASS
                    """
                }
            }
        }
    }
}
