-- =====================================================================
-- Phase 1: Catalogs (CTLGS) - Hive 3.x+ Only
-- =====================================================================
INSERT INTO target_metastore.public.ctrls (
  ctlg_id, name, description, location_uri
)
SELECT 
  ctlg_id, name, description, location_uri
FROM source_metastore.public.ctrls
WHERE NOT EXISTS (
  SELECT 1 FROM target_metastore.public.ctrls 
  WHERE ctlg_id = source_metastore.public.ctrls.ctlg_id
);

-- Validate CTLGS
SELECT 
  'CTLGS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.ctrls) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.ctrls) AS target_count;


-- =====================================================================
-- Phase 2: Core Metadata (DBS, CDS, SERDES, SDS)
-- =====================================================================

-- 2.1 Insert Databases (DBS)
INSERT INTO target_metastore.public.dbs (
  db_id, name, ctlg_name, db_location_uri, owner_name, owner_type, db_grants
)
SELECT 
  db_id, name, ctlg_name, db_location_uri, owner_name, owner_type, db_grants
FROM source_metastore.public.dbs 
WHERE name = 'abc'
AND NOT EXISTS (
  SELECT 1 FROM target_metastore.public.dbs 
  WHERE db_id = source_metastore.public.dbs.db_id
);

-- Validate DBS
SELECT 
  'DBS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.dbs WHERE name = 'abc') AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.dbs WHERE name = 'abc') AS target_count;


-- 2.2 Insert CDS (MUST come before SDS)
INSERT INTO target_metastore.public.cds (
  cd_id, name, comment
)
SELECT 
  cd_id, name, comment
FROM source_metastore.public.cds 
WHERE cd_id IN (
  SELECT DISTINCT cd_id FROM source_metastore.public.sds
)
AND NOT EXISTS (
  SELECT 1 FROM target_metastore.public.cds 
  WHERE cd_id = source_metastore.public.cds.cd_id
);

-- Validate CDS
SELECT 
  'CDS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.cds) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.cds) AS target_count;


-- 2.3 Insert SERDES (MUST come before SDS)
INSERT INTO target_metastore.public.serdes (
  serde_id, name, slib, description
)
SELECT 
  serde_id, name, slib, description
FROM source_metastore.public.serdes
WHERE serde_id IN (
  SELECT DISTINCT serde_id FROM source_metastore.public.sds
)
AND NOT EXISTS (
  SELECT 1 FROM target_metastore.public.serdes 
  WHERE serde_id = source_metastore.public.serdes.serde_id
);

-- Validate SERDES
SELECT 
  'SERDES' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.serdes) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.serdes) AS target_count;


-- 2.4 Insert SDS (with corrected columns and foreign key checks)
INSERT INTO target_metastore.public.sds (
  sd_id, cd_id, input_format, output_format, is_compressed,
  location, num_buckets, serde_id, is_storedassubdirectories
)
SELECT 
  sd_id, cd_id, input_format, output_format, is_compressed,
  location, num_buckets, serde_id, is_storedassubdirectories
FROM source_metastore.public.sds 
WHERE 
  -- Foreign key validation
  cd_id IN (SELECT cd_id FROM target_metastore.public.cds) AND
  serde_id IN (SELECT serde_id FROM target_metastore.public.serdes) AND
  sd_id IN (
    SELECT DISTINCT sd_id 
    FROM source_metastore.public.tbls 
    WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
  )
AND NOT EXISTS (
  SELECT 1 FROM target_metastore.public.sds 
  WHERE sd_id = source_metastore.public.sds.sd_id
);

-- Validate SDS
SELECT 
  'SDS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.sds 
   WHERE sd_id IN (
     SELECT sd_id FROM source_metastore.public.tbls 
     WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
   )) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.sds 
   WHERE sd_id IN (
     SELECT sd_id FROM target_metastore.public.tbls 
     WHERE db_id = (SELECT db_id FROM target_metastore.public.dbs WHERE name = 'abc')
   )) AS target_count;


--
