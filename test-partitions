-- ----------------------------------------------------------------------
-- Phase 0: Catalogs (CTLGS)
-- ----------------------------------------------------------------------

-- 0.1 Insert CTLGS
INSERT INTO target_metastore.public.ctrls (
  ctlg_id, name, description, location_uri
)
SELECT 
  ctlg_id, name, description, location_uri
FROM source_metastore.public.ctrls
WHERE NOT EXISTS (
  SELECT 1 FROM target_metastore.public.ctrls 
  WHERE name = source_metastore.public.ctrls.name
);

-- Validate CTLGS
SELECT 
  'CTLGS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.ctrls) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.ctrls) AS target_count;


-- ----------------------------------------------------------------------
-- Phase 1: Core Metadata (DBS, SERDES, SDS, CDS, TBL)
-- ----------------------------------------------------------------------

-- 1.1 Insert DBS
INSERT INTO target_metastore.public.dbs (...)
SELECT ... FROM source_metastore.public.dbs 
WHERE name = 'abc';

-- Validate DBS
SELECT 
  'DBS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.dbs WHERE name = 'abc') AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.dbs WHERE name = 'abc') AS target_count;


-- 1.2 Insert SERDES
INSERT INTO target_metastore.public.serdes (...)
SELECT ... FROM source_metastore.public.serdes;

-- Validate SERDES
SELECT 
  'SERDES' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.serdes) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.serdes) AS target_count;


-- 1.3 Insert SDS
INSERT INTO target_metastore.public.sds (...)
SELECT ... FROM source_metastore.public.sds;

-- Validate SDS
SELECT 
  'SDS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.sds) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.sds) AS target_count;


-- 1.4 Insert CDS
INSERT INTO target_metastore.public.cds (...)
SELECT ... FROM source_metastore.public.cds;

-- Validate CDS
SELECT 
  'CDS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.cds) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.cds) AS target_count;


-- 1.5 Insert TBL
INSERT INTO target_metastore.public.tbls (...)
SELECT ... FROM source_metastore.public.tbls;

-- Validate TBL
SELECT 
  'TBL' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.tbls WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.tbls WHERE db_id = (SELECT db_id FROM target_metastore.public.dbs WHERE name = 'abc')) AS target_count;


-- ----------------------------------------------------------------------
-- Phase 2: Columns & Bucketing
-- ----------------------------------------------------------------------

-- 2.1 Insert COLUMNS_V2
INSERT INTO target_metastore.public.columns_v2 (...)
SELECT ... FROM source_metastore.public.columns_v2;

-- Validate COLUMNS_V2
SELECT 
  'COLUMNS_V2' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.columns_v2) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.columns_v2) AS target_count;


-- 2.2 Insert BUCKETING_COLS
INSERT INTO target_metastore.public.bucketing_cols (...)
SELECT ... FROM source_metastore.public.bucketing_cols;

-- Validate BUCKETING_COLS
SELECT 
  'BUCKETING_COLS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.bucketing_cols) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.bucketing_cols) AS target_count;


-- ----------------------------------------------------------------------
-- Phase 3: Partitions
-- ----------------------------------------------------------------------

-- 3.1 Insert PARTITIONS
INSERT INTO target_metastore.public.partitions (...)
SELECT ... FROM source_metastore.public.partitions;

-- Validate PARTITIONS
SELECT 
  'PARTITIONS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.partitions WHERE tbl_id IN (SELECT tbl_id FROM source_metastore.public.tbls WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc'))) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.partitions WHERE tbl_id IN (SELECT tbl_id FROM target_metastore.public.tbls WHERE db_id = (SELECT db_id FROM target_metastore.public.dbs WHERE name = 'abc'))) AS target_count;


-- 3.2 Insert PARTITION_KEYS
INSERT INTO target_metastore.public.partition_keys (...)
SELECT ... FROM source_metastore.public.partition_keys;

-- Validate PARTITION_KEYS
SELECT 
  'PARTITION_KEYS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.partition_keys WHERE tbl_id IN (SELECT tbl_id FROM source_metastore.public.tbls WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc'))) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.partition_keys WHERE tbl_id IN (SELECT tbl_id FROM target_metastore.public.tbls WHERE db_id = (SELECT db_id FROM target_metastore.public.dbs WHERE name = 'abc'))) AS target_count;


-- ----------------------------------------------------------------------
-- Phase 4: Parameters & Advanced Features
-- ----------------------------------------------------------------------

-- 4.1 Insert TABLE_PARAMS
INSERT INTO target_metastore.public.table_params (...)
SELECT ... FROM source_metastore.public.table_params;

-- Validate TABLE_PARAMS
SELECT 
  'TABLE_PARAMS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.table_params WHERE tbl_id IN (SELECT tbl_id FROM source_metastore.public.tbls WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc'))) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.table_params WHERE tbl_id IN (SELECT tbl_id FROM target_metastore.public.tbls WHERE db_id = (SELECT db_id FROM target_metastore.public.dbs WHERE name = 'abc'))) AS target_count;


-- 4.2 Insert PARTITION_PARAMS
INSERT INTO target_metastore.public.partition_params (...)
SELECT ... FROM source_metastore.public.partition_params;

-- Validate PARTITION_PARAMS
SELECT 
  'PARTITION_PARAMS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.partition_params WHERE part_id IN (SELECT part_id FROM source_metastore.public.partitions))
