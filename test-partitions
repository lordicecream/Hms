-- ----------------------------------------------------------------------
-- Phase 0: Replicate Catalogs (CTLGS)
-- Required for Hive 3.x+
-- ----------------------------------------------------------------------
INSERT INTO target_metastore.public.ctrls (
  ctlg_id, name, description, location_uri
)
SELECT 
  ctlg_id, name, description, location_uri
FROM source_metastore.public.ctrls
WHERE NOT EXISTS (
  SELECT 1 FROM target_metastore.public.ctrls 
  WHERE name = source_metastore.public.ctrls.name
);


-- ----------------------------------------------------------------------
-- Phase 1: Core Metadata (DBS, SDS, CDS, SERDES, TBL)
-- ----------------------------------------------------------------------

-- 1.1 DBS (databases)
INSERT INTO target_metastore.public.dbs (
  db_id, name, ctlg_name, db_location_uri, owner_name, owner_type, db_grants
)
SELECT 
  db_id, name, ctlg_name, db_location_uri, owner_name, owner_type, db_grants
FROM source_metastore.public.dbs 
WHERE name = 'abc'
AND NOT EXISTS (
  SELECT 1 FROM target_metastore.public.dbs WHERE name = 'abc'
);


-- 1.2 SERDES (serialization/deserialization)
INSERT INTO target_metastore.public.serdes (
  serde_id, name, slib, description
)
SELECT 
  serde_id, name, slib, description
FROM source_metastore.public.serdes
WHERE serde_id IN (
  SELECT DISTINCT serde_id FROM source_metastore.public.sds
)
AND NOT EXISTS (
  SELECT 1 FROM target_metastore.public.serdes 
  WHERE serde_id = s.serde_id
);


-- 1.3 SDS (storage descriptors)
INSERT INTO target_metastore.public.sds (
  sd_id, cd_id, input_format, output_format, is_compacted, 
  location, num_buckets, serde_id
)
SELECT 
  sd_id, cd_id, input_format, output_format, is_compacted, 
  location, num_buckets, serde_id
FROM source_metastore.public.sds 
WHERE sd_id IN (
  SELECT DISTINCT sd_id FROM source_metastore.public.tbls 
  WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
)
AND NOT EXISTS (
  SELECT 1 FROM target_metastore.public.sds 
  WHERE sd_id = s.sd_id
);


-- 1.4 CDS (column descriptors)
INSERT INTO target_metastore.public.cds (
  cd_id, name, comment
)
SELECT 
  cd_id, name, comment
FROM source_metastore.public.cds 
WHERE cd_id IN (
  SELECT DISTINCT cd_id FROM source_metastore.public.sds
)
AND NOT EXISTS (
  SELECT 1 FROM target_metastore.public.cds 
  WHERE cd_id = c.cd_id
);


-- 1.5 TBL (tables)
INSERT INTO target_metastore.public.tbls (
  tbl_id, tbl_name, db_id, sd_id, tbl_type, 
  owner, retention, create_time, last_access_time
)
SELECT 
  tbl_id, tbl_name, db_id, sd_id, tbl_type, 
  owner, retention, create_time, last_access_time
FROM source_metastore.public.tbls 
WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
AND NOT EXISTS (
  SELECT 1 FROM target_metastore
