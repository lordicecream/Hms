-- =====================================================================
-- Phase 1: Catalogs (CTLGS) - Hive 3.x+ Only
-- =====================================================================

-- 1.1 Insert Catalogs
INSERT INTO target_metastore.public.ctrls (
  ctlg_id, name, description, location_uri
)
SELECT 
  ctlg_id, name, description, location_uri
FROM source_metastore.public.ctrls
WHERE NOT EXISTS (
  SELECT 1 FROM target_metastore.public.ctrls 
  WHERE ctlg_id = source_metastore.public.ctrls.ctlg_id
);

-- Validate CTLGS
SELECT 
  'CTLGS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.ctrls) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.ctrls) AS target_count;


-- =====================================================================
-- Phase 2: Core Metadata (DBS, SDS, SERDES, CDS)
-- =====================================================================

-- 2.1 Insert Databases (DBS)
INSERT INTO target_metastore.public.dbs (
  db_id, name, ctlg_name, db_location_uri, owner_name, owner_type, db_grants
)
SELECT 
  db_id, name, ctlg_name, db_location_uri, owner_name, owner_type, db_grants
FROM source_metastore.public.dbs 
WHERE name = 'abc'
AND NOT EXISTS (
  SELECT 1 FROM target_metastore.public.dbs 
  WHERE db_id = source_metastore.public.dbs.db_id
);

-- Validate DBS
SELECT 
  'DBS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.dbs WHERE name = 'abc') AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.dbs WHERE name = 'abc') AS target_count;


-- 2.2 Insert Storage Descriptors (SDS)
INSERT INTO target_metastore.public.sds (
  sd_id, cd_id, input_format, output_format, is_compacted, 
  location, num_buckets, serde_id
)
SELECT 
  sd_id, cd_id, input_format, output_format, is_compacted, 
  location, num_buckets, serde_id
FROM source_metastore.public.sds 
WHERE sd_id IN (
  SELECT DISTINCT sd_id 
  FROM source_metastore.public.tbls 
  WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
)
AND NOT EXISTS (
  SELECT 1 FROM target_metastore.public.sds 
  WHERE sd_id = source_metastore.public.sds.sd_id
);

-- Validate SDS
SELECT 
  'SDS' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.sds 
   WHERE sd_id IN (
     SELECT sd_id FROM source_metastore.public.tbls 
     WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
   )) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.sds 
   WHERE sd_id IN (
     SELECT sd_id FROM target_metastore.public.tbls 
     WHERE db_id = (SELECT db_id FROM target_metastore.public.dbs WHERE name = 'abc')
   )) AS target_count;


-- =====================================================================
-- Phase 3: Tables & Columns (TBL, COLUMNS_V2)
-- =====================================================================

-- 3.1 Insert Tables (TBL)
INSERT INTO target_metastore.public.tbls (
  tbl_id, tbl_name, db_id, sd_id, tbl_type, 
  owner, retention, create_time, last_access_time
)
SELECT 
  tbl_id, tbl_name, db_id, sd_id, tbl_type, 
  owner, retention, create_time, last_access_time
FROM source_metastore.public.tbls 
WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
AND NOT EXISTS (
  SELECT 1 FROM target_metastore.public.tbls 
  WHERE tbl_id = source_metastore.public.tbls.tbl_id
);

-- Validate TBL
SELECT 
  'TBL' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.tbls 
   WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.tbls 
   WHERE db_id = (SELECT db_id FROM target_metastore.public.dbs WHERE name = 'abc')) AS target_count;


-- 3.2 Insert Columns (COLUMNS_V2)
INSERT INTO target_metastore.public.columns_v2 (
  cd_id, comment, column_name, type_name, integer_idx
)
SELECT 
  cd_id, comment, column_name, type_name, integer_idx
FROM source_metastore.public.columns_v2 
WHERE cd_id IN (
  SELECT cd_id FROM target_metastore.public.cds
)
AND NOT EXISTS (
  SELECT 1 FROM target_metastore.public.columns_v2 
  WHERE cd_id = source_metastore.public.columns_v2.cd_id 
  AND column_name = source_metastore.public.columns_v2.column_name
);

-- Validate COLUMNS_V2
SELECT 
  'COLUMNS_V2' AS table_name,
  (SELECT COUNT(*) FROM source_metastore.public.columns_v2) AS source_count,
  (SELECT COUNT(*) FROM target_metastore.public.columns_v2) AS target_count;


-- =====================================================================
-- Phase 4: Partitions (PARTITIONS, PARTITION_KEYS, PARTITION_PARAMS)
-- =====================================================================

-- 4.1 Insert Partitions (PARTITIONS)
INSERT INTO target_metastore.public.partitions (
  part_id, part_name, tbl
