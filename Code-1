import trino
from trino.auth import BasicAuthentication
from trino.dbapi import connect

def connect_to_trino(host, port, user, password):
    return connect(
        host=host,
        port=int(port),
        user=user,
        auth=BasicAuthentication(user, password),
        http_scheme='https',
        catalog='system',
        verify=False
    )

def schema_exists(conn, catalog, schema):
    cursor = conn.cursor()
    cursor.execute(f"SHOW SCHEMAS FROM {catalog}")
    schemas = [row[0] for row in cursor.fetchall()]
    return schema in schemas

def get_create_schema_sql(conn, catalog, schema):
    cursor = conn.cursor()
    cursor.execute(f"SHOW CREATE SCHEMA {catalog}.{schema}")
    return cursor.fetchall()[0][0]

def list_tables(conn, catalog, schema):
    cursor = conn.cursor()
    cursor.execute(f"SHOW TABLES FROM {catalog}.{schema}")
    return [row[0] for row in cursor.fetchall()]

def get_create_table_sql(conn, catalog, schema, table):
    cursor = conn.cursor()
    cursor.execute(f"SHOW CREATE TABLE {catalog}.{schema}.{table}")
    return cursor.fetchall()[0][0]

def replicate_schema_if_missing(source_conn, dest_conn, source_catalog, dest_catalog, schema):
    if not schema_exists(dest_conn, dest_catalog, schema):
        create_schema_sql = get_create_schema_sql(source_conn, source_catalog, schema)
        adjusted_sql = create_schema_sql.replace(f"{source_catalog}.{schema}", f"{dest_catalog}.{schema}")
        dest_conn.cursor().execute(adjusted_sql)

def replicate_selected_tables(source_conn, dest_conn, source_catalog, dest_catalog, schema, table_list):
    dest_tables = list_tables(dest_conn, dest_catalog, schema)

    for table in table_list:
        table = table.strip()
        if table and table not in dest_tables:
            create_table_sql = get_create_table_sql(source_conn, source_catalog, schema, table)
            adjusted_sql = create_table_sql.replace(f"{source_catalog}.{schema}.{table}", f"{dest_catalog}.{schema}.{table}")
            dest_conn.cursor().execute(adjusted_sql)

# -------------- Configuration --------------------
# You will pass these via Jenkins later
source_host = 'your-trino-source-host'
dest_host = 'your-trino-dest-host'
port = 443
user = 'your-user'
password = 'your-password'
source_catalog = 'hmsa'
dest_catalog = 'hmsb'
schema = 'abc'
full_schema_replicate = False  # set True for full schema
table_list_file = 'tables_to_replicate.txt'  # used only if full_schema_replicate is False

# -------------- Connect --------------------------
source_conn = connect_to_trino(source_host, port, user, password)
dest_conn = connect_to_trino(dest_host, port, user, password)

# -------------- Schema Check/Create --------------
replicate_schema_if_missing(source_conn, dest_conn, source_catalog, dest_catalog, schema)

# -------------- Table Replication ----------------
if full_schema_replicate:
    source_tables = list_tables(source_conn, source_catalog, schema)
    replicate_selected_tables(source_conn, dest_conn, source_catalog, dest_catalog, schema, source_tables)
else:
    with open(table_list_file, 'r') as f:
        table_list = f.read().strip().split(',')
    replicate_selected_tables(source_conn, dest_conn, source_catalog, dest_catalog, schema, table_list)
