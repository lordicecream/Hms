-- Step 1: Ensure the abc schema exists in the target metastore
INSERT INTO target_metastore.public.dbs 
SELECT * FROM source_metastore.public.dbs 
WHERE name = 'abc' 
AND NOT EXISTS (
    SELECT 1 FROM target_metastore.public.dbs WHERE name = 'abc'
);

-- Step 2: Copy all tables in abc schema
INSERT INTO target_metastore.public.tbls 
SELECT * FROM source_metastore.public.tbls 
WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc') 
AND NOT EXISTS (
    SELECT 1 FROM target_metastore.public.tbls 
    WHERE db_id = (SELECT db_id FROM target_metastore.public.dbs WHERE name = 'abc')
);

-- Step 3: Copy all storage descriptors (SDS) for tables in abc schema
INSERT INTO target_metastore.public.sds 
SELECT * FROM source_metastore.public.sds 
WHERE sd_id IN (
    SELECT sd_id FROM source_metastore.public.tbls 
    WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
) 
AND NOT EXISTS (
    SELECT 1 FROM target_metastore.public.sds 
    WHERE sd_id IN (
        SELECT sd_id FROM target_metastore.public.tbls 
        WHERE db_id = (SELECT db_id FROM target_metastore.public.dbs WHERE name = 'abc')
    )
);

-- Step 4: Copy all column definitions (columns_v2) for tables in abc schema
INSERT INTO target_metastore.public.columns_v2 
SELECT * FROM source_metastore.public.columns_v2 
WHERE cd_id IN (
    SELECT cd_id FROM source_metastore.public.sds 
    WHERE sd_id IN (
        SELECT sd_id FROM source_metastore.public.tbls 
        WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
    )
) 
AND NOT EXISTS (
    SELECT 1 FROM target_metastore.public.columns_v2 
    WHERE cd_id IN (
        SELECT cd_id FROM target_metastore.public.sds 
        WHERE sd_id IN (
            SELECT sd_id FROM target_metastore.public.tbls 
            WHERE db_id = (SELECT db_id FROM target_metastore.public.dbs WHERE name = 'abc')
        )
    )
);

-- Step 5: Copy partition keys for partitioned tables in abc schema
INSERT INTO target_metastore.public.partition_keys 
SELECT * FROM source_metastore.public.partition_keys 
WHERE tbl_id IN (
    SELECT tbl_id FROM source_metastore.public.tbls 
    WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
) 
AND NOT EXISTS (
    SELECT 1 FROM target_metastore.public.partition_keys 
    WHERE tbl_id IN (
        SELECT tbl_id FROM target_metastore.public.tbls 
        WHERE db_id = (SELECT db_id FROM target_metastore.public.dbs WHERE name = 'abc')
    )
);

-- Step 6: Copy partitions for partitioned tables in abc schema
INSERT INTO target_metastore.public.partitions 
SELECT * FROM source_metastore.public.partitions 
WHERE tbl_id IN (
    SELECT tbl_id FROM source_metastore.public.tbls 
    WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
) 
AND NOT EXISTS (
    SELECT 1 FROM target_metastore.public.partitions 
    WHERE tbl_id IN (
        SELECT tbl_id FROM target_metastore.public.tbls 
        WHERE db_id = (SELECT db_id FROM target_metastore.public.dbs WHERE name = 'abc')
    )
);

-- Step 7: Copy SDS for partitions
INSERT INTO target_metastore.public.sds 
SELECT * FROM source_metastore.public.sds 
WHERE sd_id IN (
    SELECT sd_id FROM source_metastore.public.partitions 
    WHERE tbl_id IN (
        SELECT tbl_id FROM source_metastore.public.tbls 
        WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
    )
) 
AND NOT EXISTS (
    SELECT 1 FROM target_metastore.public.sds 
    WHERE sd_id IN (
        SELECT sd_id FROM target_metastore.public.partitions 
        WHERE tbl_id IN (
            SELECT tbl_id FROM target_metastore.public.tbls 
            WHERE db_id = (SELECT db_id FROM target_metastore.public.dbs WHERE name = 'abc')
        )
    )
);

-- Step 8: Copy column definitions for partitions
INSERT INTO target_metastore.public.columns_v2 
SELECT * FROM source_metastore.public.columns_v2 
WHERE cd_id IN (
    SELECT cd_id FROM source_metastore.public.sds 
    WHERE sd_id IN (
        SELECT sd_id FROM source_metastore.public.partitions
