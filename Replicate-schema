-- Step 1: Insert abc Schema Without db_id Check
INSERT INTO target_metastore.public.dbs 
SELECT * FROM source_metastore.public.dbs 
WHERE name = 'abc'
AND NOT EXISTS (
    SELECT 1 FROM target_metastore.public.dbs WHERE name = 'abc'
);

-- Step 2: Insert Column Descriptors (cds)
INSERT INTO target_metastore.public.cds
SELECT * FROM source_metastore.public.cds
WHERE cd_id IN (
    SELECT cd_id FROM source_metastore.public.sds 
    WHERE sd_id IN (
        SELECT sd_id FROM source_metastore.public.tbls 
        WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
    )
)
AND NOT EXISTS (
    SELECT 1 FROM target_metastore.public.cds WHERE cd_id = source_metastore.public.cds.cd_id
);

-- Step 3: Insert Storage Descriptors (sds)
INSERT INTO target_metastore.public.sds
SELECT * FROM source_metastore.public.sds 
WHERE sd_id IN (
    SELECT sd_id FROM source_metastore.public.tbls 
    WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
)
AND NOT EXISTS (
    SELECT 1 FROM target_metastore.public.sds WHERE sd_id = source_metastore.public.sds.sd_id
);

-- Step 4: Insert Tables (tbls)
INSERT INTO target_metastore.public.tbls 
SELECT * FROM source_metastore.public.tbls 
WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
AND NOT EXISTS (
    SELECT 1 FROM target_metastore.public.tbls WHERE tbl_id = source_metastore.public.tbls.tbl_id
);

-- Step 5: Insert Columns Metadata (columns_v2)
INSERT INTO target_metastore.public.columns_v2
SELECT * FROM source_metastore.public.columns_v2
WHERE cd_id IN (
    SELECT cd_id FROM source_metastore.public.cds 
    WHERE cd_id IN (
        SELECT cd_id FROM source_metastore.public.sds 
        WHERE sd_id IN (
            SELECT sd_id FROM source_metastore.public.tbls 
            WHERE db_id = (SELECT db_id FROM source_metastore.public.dbs WHERE name = 'abc')
        )
    )
)
AND NOT EXISTS (
    SELECT 1 FROM target_metastore.public.columns_v2 WHERE cd_id = source_metastore.public.columns_v2.cd_id
);
